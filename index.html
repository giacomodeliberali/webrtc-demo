<!doctype html>

<html>

<head>
    <title>WebSocket with WebRTC Calling - PeerJS</title>
    <meta charset="utf-8" />

    <meta name="viewport"
        content="viewport-fit=cover, width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />

    <link rel="icon" type="image/png" href="assets/icon/favicon.png" />

    <!-- add to homescreen for ios -->
    <link rel="apple-touch-icon" sizes="180x180" href="assets/icons/icon-192x192.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black" />
    <link rel="manifest" href="manifest.webmanifest" />
    <meta name="theme-color" content="#1976d2" />

    <script src="peerjs.min.js"></script>

    <style>
        video {
            width: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div>
            <p>
                Your id: <span id="myId"></span>
            </p>
            <p>
                Enter a remote id:
                <input id="targetId" type="text" placeholder="Target id">
                <input type="button" value="Call" onclick="call()">
            </p>
        </div>


        <div>
            <video id="received_video" autoplay></video>
            <video id="local_video" autoplay muted></video>
        </div>

        <input type="button" value="Close" onclick="close_call()">
    </div>

    <script>
        let randomId = Math.random().toString(36).substring(3);
        const peer = new Peer(randomId, {
            host: 'webrtc-peerjs.azurewebsites.net',
            port: 443,
            path: '/'
        });


        peer.on('open', function (id) {
            console.log(`My id is ${id}`)
            document.getElementById("myId").innerHTML = id;
        });

        let currentCall = null;

        async function call() {
            const id = document.getElementById("targetId").value
            console.log("Calling " + id);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById("local_video").srcObject = stream;
                document.getElementById("local_video").play()

                const call = peer.call(id, stream);
                call.on('stream', function (remoteStream) {
                    document.getElementById("received_video").srcObject = remoteStream
                    document.getElementById("received_video").play()
                });


                currentCall = call;
            } catch (ex) {
                console.error(ex);
            }
        }

        peer.on('call', async (call) => {

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById("local_video").srcObject = stream;
                document.getElementById("local_video").play()

                call.answer(stream); // Answer the call with an A/V stream.
                call.on('stream', function (remoteStream) {

                    // Show stream in some video/canvas element.
                    document.getElementById("received_video").srcObject = remoteStream
                    document.getElementById("received_video").play()
                });
                currentCall = call;
            } catch (ex) {
                console.error(ex);
            }
        });

        function close_call() {
            document.getElementById("received_video").pause = true
            document.getElementById("local_video").pause = true
            currentCall.close();
        }

                if ('serviceWorker' in navigator) {
                    window.addEventListener('load', function () {
                        navigator.serviceWorker.register('service-worker.js').then(function (registration) {
                            // Registration was successful
                            console.log('ServiceWorker registration successful with scope: ', registration.scope);
                        }, function (err) {
                            // registration failed :(
                            console.log('ServiceWorker registration failed: ', err);
                        });
                    });
                }
    </script>
</body>

</html>