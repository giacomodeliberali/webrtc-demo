<!doctype html>

<html>

<head>
    <title>WebSocket with WebRTC Calling - PeerJS</title>
    <meta charset="utf-8">
    <script src="https://unpkg.com/peerjs@1.0.0/dist/peerjs.min.js"></script>

    <style>
        video {
            width: 200px;
        }
    </style>
</head>

<body>
    <div class="container">
        <div>
            <p>
                Your id: <span id="myId"></span>
            </p>
            <p>
                Enter a remote id:
                <input id="targetId" type="text" placeholder="Target id">
                <input type="button" value="Call" onclick="call()">
            </p>
        </div>


        <div>
            <video id="received_video" autoplay></video>
            <video id="local_video" autoplay muted></video>
        </div>

        <input type="button" value="Close" onclick="close_call()">
    </div>

    <script>
        /*         var peer = new Peer({
                    host: 'localhost',
                    port: 9000,
                    path: '/myapp'
                }); */

        var peer = new Peer();

        peer.on('open', function (id) {
            document.getElementById("myId").innerHTML = id;
        });

        let currentCall = null;

        async function call() {
            const id = document.getElementById("targetId").value
            console.log("Calling " + id);

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById("local_video").srcObject = stream;

                const call = peer.call(id, stream);
                call.on('stream', function (remoteStream) {
                    document.getElementById("received_video").srcObject = remoteStream
                });


                currentCall = call;
            } catch (ex) {
                console.error(ex);
            }
        }

        peer.on('call', async (call) => {

            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                document.getElementById("local_video").srcObject = stream;

                call.answer(stream); // Answer the call with an A/V stream.
                call.on('stream', function (remoteStream) {

                    // Show stream in some video/canvas element.
                    document.getElementById("received_video").srcObject = remoteStream
                });
                currentCall = call;
            } catch (ex) {
                console.error(ex);
            }
        });

        function close_call() {
            document.getElementById("received_video").pause = true
            document.getElementById("local_video").pause = true
            currentCall.close();
        }
    </script>
</body>

</html>